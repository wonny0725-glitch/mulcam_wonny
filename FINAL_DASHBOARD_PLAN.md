# 서울교통공사 지하철 혼잡도(Streamlit) 대시보드 구현 계획 (최종본)

## 📊 진행 상황
- ✅ **Phase 0**: 요구사항/정의 확정 (완료)
- ✅ **Phase 1**: 데이터 로딩/전처리 모듈 (완료)
- ✅ **Phase 2**: MVP 대시보드 (완료) + 히트맵 추가
- ✅ **Phase 3**: 분석 뷰 확장 (완료)
- ⏳ **Phase 4**: UX/성능/배포 (예정)
- 🔸 **Phase 5**: 고급 기능 (일부 완료 - 히트맵/색상 임계치)

---

## 1) 목표 / 대상 사용자
- **대상**: 일반 사용자
- **목적**: 혼잡 TOP역 관리, 노선별 혼잡 비교
- **핵심 사용 시나리오**
  - “지금 데이터 기준으로” 가장 혼잡한 역 TOP10을 빠르게 확인
  - 노선별로 어느 노선이 상대적으로 혼잡한지 비교
  - 특정 역을 선택해 시간대별 혼잡 패턴(피크 시간/피크 수치) 확인

## 2) 데이터 요약(현재 CSV 기반)
파일: `서울교통공사_지하철혼잡도정보_20250930.csv`

- **형태**: 시간대 컬럼이 가로로 긴 wide format
- **산출 기준**
  - 서울교통공사 **1~8호선** 대상
  - **30분 단위 평균 혼잡도**: 해당 30분 동안 **해당 역을 통과한 모든 열차의 평균 혼잡도**를 산출
- **컬럼 구조(예상)**
  - 메타(앞 5개): `요일구분`, `호선`, `역번호`, `역명`, `상하선 구분(방향)`
  - 값(나머지): `5시30분` ~ `00시30분` (30분 단위) 혼잡도 값
- **중요 주의**
  - 본 프로젝트에서는 “오늘”을 **기준일(date)** 개념으로 명확히 정의한다.
  - 기준일은 우선 **파일명에서 `YYYYMMDD`를 파싱**해 사용한다. (예: `..._20250930.csv` → `2025-09-30`)
  - 만약 파일명에서 날짜 파싱이 불가능하면, 사용자가 **기준일을 직접 선택/입력**하도록 한다.
  - UI는 “오늘의 TOP10”처럼 표현하되, 내부적으로는 **선택된 기준일**을 사용한다.

### 2.1 범주 값(확정)
- **요일구분**: `평일, 토요일, 일요일`
- **상하선 구분(방향)**: `상행, 하행`

## 3) 지표 정의(확정 필요/권장 기본값)
### 3.0 혼잡도 단위/해석(본 프로젝트에서 고정)
- **혼잡도 단위**: 열차 **정원 대비 실제 승차 인원의 비율(단위: %)**.
- **참고 기준(서울교통공사 정의)**: 정원 기준으로 **좌석만 모두 찼을 경우 혼잡도 34%**로 산정.
- **표기 규칙(권장 기본 임계치, %)**: *(추후 UX 테스트로 조정 가능)*
  - `0~34`: 좌석 여유~좌석 만석(기준선)
  - `34~100`: 입석 포함(정원 이내)
  - `100 이상`: 정원 초과(매우 혼잡)

### 3.1 피크 관련
- **피크 혼잡(peak_crowding)**: 선택 범위 내 시간대 값의 `max`
- **피크 시간(peak_time)**: `max`가 발생한 시간
  - 동률 처리 룰: 기본값 **가장 이른 시간**(추후 변경 가능)

### 3.2 출근/퇴근 구간 평균
- **출근 평균(commute_avg)**: 7:00~9:00 시간대의 `mean`
  - UI 토글: “9:00 포함” (기본 ON 권장)
- **퇴근 평균(evening_avg)**: 17:00~20:00 시간대의 `mean`
  - UI 토글: “20:00 포함” (기본 ON 권장)

## 4) 화면 구성(MVP)
### 4.1 사이드바 필터
- `기준일` (단일 선택; 기본값=파일명에서 파싱된 날짜)
- `요일구분(평일/토요일/일요일)` (멀티 선택)
- `호선` (멀티 선택)
- `방향(상행/하행)` (멀티 선택)
- `역명 검색`(부분 문자열 포함 검색)
- 출근/퇴근 구간 토글(9:00 포함, 20:00 포함)

### 4.2 메인 KPI
- 선택 범위의 **최대 피크 혼잡**
- **출근 평균(7~9시)**
- **퇴근 평균(17~20시)**

### 4.3 주요 컴포넌트
- **피크 TOP10 테이블**(기본): 피크 혼잡 기준 상위 10개(노선/역/방향/요일 포함)
- **시간대별 라인차트**: 특정 역 선택 시 시간대별 혼잡(방향별 라인)
- **역별 피크혼잡/피크시간 테이블**: 역 단위 요약(피크혼잡+피크시간)

## 5) 구현 페이즈(Phase) 계획
### Phase 0 — 요구사항/정의 확정 (0.5일) ✅ **완료**
- ✅ 지표 정의 확정: 피크/평균 구간 포함 규칙, 동률 처리
- ✅ UI 표기 확정: "오늘"은 **기준일(date)** 기준으로 표기("데이터 기준" 문구는 보조 안내로 유지)
- ✅ 필터 확정: 기준일/요일/호선/방향/역검색 + 구간 토글

**완료 기준(DoD)** ✅
- ✅ 계산 규칙이 문서로 고정되고, 모든 화면 문구가 데이터 특성과 충돌하지 않음
- ✅ FINAL_DASHBOARD_PLAN.md 최종 확정

### Phase 1 — 데이터 로딩/전처리 모듈 (0.5~1일) ✅ **완료**
- ✅ CSV 인코딩 처리(cp949/euc-kr/utf-8 폴백)
- ✅ wide→long 변환(`melt`)으로 `time/hour/minute/crowding` 컬럼 생성
- ✅ 결측/비수치 처리(`to_numeric(errors="coerce")`)
- ✅ 캐싱 적용(`st.cache_data`)
- ✅ 형식 오류 시 사용자 안내 메시지(시간 컬럼 파싱 실패 등)
- ✅ 컬럼명 표준화(출발역→역명, 상하구분→상하선구분)
- ✅ 기준일 파싱(파일명에서 YYYYMMDD 추출)

**완료 기준(DoD)** ✅
- ✅ 업로드한 CSV가 안정적으로 로딩되고 시간 정렬/필터가 정확히 동작
- ✅ data_loader.py 모듈 구현 완료
- ✅ app.py 기본 구조 구현 완료
- ✅ Streamlit 앱 정상 실행 확인

### Phase 2 — MVP 대시보드 (1일) ✅ **완료**
- ✅ 사이드바 필터 구현
- ✅ KPI 3개 구현(피크/출근/퇴근)
- ✅ 피크 TOP10 테이블 구현
- ✅ 역 선택 라인차트 구현(방향별 비교)
- ✅ 역별 피크 테이블 구현

**완료 기준(DoD)** ✅
- ✅ 필터 조합을 바꿔도 오류 없이 KPI/표/차트가 일관되게 갱신

### Phase 3 — 분석 뷰 확장 (1일) ✅ **완료**
- ✅ 랭킹 탭 분리: `피크 TOP10` / `출근 평균 TOP10` / `퇴근 평균 TOP10`
- ✅ 노선별 비교 차트 추가(노선 단위 평균/피크 요약)
- ✅ "역별 요약" 테이블에 출근/퇴근 평균 컬럼까지 합치기

**완료 기준(DoD)** ✅
- ✅ 노선 비교와 TOP 랭킹 기준이 명확하고, 사용자 입장에서 "왜 TOP인지" 해석 가능

### Phase 4 — UX/성능/배포 (0.5~1일)
- 필터 적용 결과 다운로드(CSV)
- 연산 최적화(불필요 그룹바이 최소화, 캐시 범위 조정)
- 실행 문서화: 설치/실행 방법(Windows 기준)

**완료 기준(DoD)**
- 일반 사용자가 README만 보고 실행 가능, 대용량에서도 응답 지연이 과도하지 않음

### Phase 5 — (옵션) 고급 기능 (1~2일)
- ✅ 시간×노선 히트맵(피크 구간 직관화) - Phase 2에서 구현 완료
- ✅ 임계치("혼잡" 기준) 기반 색상/경고 - 히트맵에 적용 완료
- ⏳ 지도 시각화(역 위경도/매핑 테이블 필요)

## 6) 리스크/확인 과제(짧게)
- **기준일 파싱 실패 가능성**: 파일명 규칙이 바뀌면 기준일을 직접 입력받는 UX가 필요
- **"오늘" 데이터 범위**: 파일이 실제로 1일치가 아니라면, 기준일은 "데이터 생성일/대표일"로 취급(표기 시 안내 문구 추가)

---

## 7) 완료 이력

### 2025-12-16
**Phase 0 완료**
- FINAL_DASHBOARD_PLAN.md 최종 확정
- 지표 정의, UI 표기, 필터 규칙 확정

**Phase 1 완료**
- `data_loader.py`: CSV 로딩/전처리 모듈 구현
  - 다중 인코딩 지원 (cp949/euc-kr/utf-8)
  - Wide-to-Long 변환
  - 시간 파싱 (00시30분 → 24:30 처리)
  - 컬럼명 표준화 (출발역→역명, 상하구분→상하선구분)
  - 기준일 파싱 (파일명에서 YYYYMMDD 추출)
  - 캐싱 적용
- `app.py`: Streamlit 기본 대시보드 구현
  - 데이터 로딩 및 오류 처리
  - 데이터 요약 메트릭
  - 데이터 미리보기
  - 필터링 테스트
- `requirements.txt`: 의존성 패키지 정의
- Git 커밋 및 푸시 완료 (commit: fd7447d)

**구현 파일**
- data_loader.py (170줄)
- app.py (103줄)
- requirements.txt
- .gitignore
- PHASE1_VERIFICATION.md (검증 문서)
- PHASE1_FIX.md (수정 사항 문서)

**Phase 2 완료** (2025-12-16)
- `data_loader.py`: 분석 함수 추가 (335줄)
  - `calculate_peak()`: 피크 혼잡도와 피크 시간 계산
  - `calculate_commute_avg()`: 출근시간(7~9시) 평균 혼잡도 계산
  - `calculate_evening_avg()`: 퇴근시간(17~20시) 평균 혼잡도 계산
  - `get_peak_top10()`: 피크 혼잡 TOP10 테이블 생성
  - `get_station_peak_summary()`: 역별 피크 요약 테이블 생성
- `app.py`: MVP 대시보드 전면 재구성 (262줄)
  - 사이드바 필터 구현 (요일/호선/방향/역검색/출퇴근 시간 토글)
  - KPI 메트릭 3개 (최대 피크 혼잡, 출근시간 평균, 퇴근시간 평균)
  - 피크 TOP10 테이블 (호선/역명/방향/요일별)
  - 역별 시간대별 라인차트 (Plotly, 방향별 비교)
  - 역별 피크 요약 테이블
- `requirements.txt`: plotly>=5.0.0 추가
- Git 커밋 및 푸시 완료 (commit: f30d1b4)

**Phase 2 완료 기준 충족**
- ✅ 필터 조합을 바꿔도 오류 없이 KPI/표/차트가 일관되게 갱신
- ✅ 모든 필터가 정상 동작 (빈 결과 시 안내 메시지 표시)
- ✅ 차트/테이블이 한글로 표시되고 가독성 확보

**Phase 2 추가 개선** (2025-12-16)
- `app.py`: 전체 노선 시간대별 혼잡도 히트맵 추가 (352줄)
  - 1~8호선 상행/하행 전체 노선의 시간대별 평균 혼잡도를 한눈에 비교
  - 색상 그라데이션: 흰색(여유) → 노란색 → 주황색 → 붉은색(혼잡)
  - Plotly 히트맵 (Heatmap) 사용
  - 혼잡도 기준 색상 표시:
    - 🤍 흰색/연한색 (0-34%): 좌석 여유~만석
    - 🟡 노란색 (34-70%): 입석 포함 (정원 이내)
    - 🟠 주황색 (70-100%): 혼잡
    - 🔴 붉은색 (100% 이상): 매우 혼잡 (정원 초과)
  - 마우스 오버 시 정확한 혼잡도 수치 표시
  - 사이드바 필터 적용 가능

**Phase 3 완료** (2025-12-16)
- `data_loader.py`: 분석 함수 4개 추가 (454줄, +118줄)
  - `get_commute_top10()`: 출근시간(7~9시) 평균 혼잡도 TOP10 테이블
  - `get_evening_top10()`: 퇴근시간(17~20시) 평균 혼잡도 TOP10 테이블
  - `get_line_summary()`: 노선별 혼잡도 요약 (평균/피크/출근/퇴근)
  - `get_station_full_summary()`: 역별 종합 요약 (피크+출근평균+퇴근평균)
- `app.py`: 분석 뷰 전면 확장 (487줄, +135줄)
  - 랭킹 섹션을 3개 탭으로 분리 (피크/출근평균/퇴근평균 TOP10)
  - 노선별 혼잡도 비교 섹션 추가
    - Plotly 그룹 바 차트 (4가지 지표: 전체평균/피크/출근/퇴근)
    - 색상 구분 및 수치 라벨 표시
    - Expander로 상세 수치 테이블 제공
  - 역별 종합 요약 테이블 확장 (피크+출근평균+퇴근평균 컬럼 추가)

**Phase 3 완료 기준 충족**
- ✅ 3개의 랭킹 탭이 정상 동작하고, 각 탭에서 해당 기준의 TOP10이 표시됨
- ✅ 노선별 비교 차트에서 어느 노선이 혼잡한지 직관적으로 파악 가능
- ✅ 역별 요약 테이블에서 출근/퇴근 평균까지 한눈에 확인 가능
- ✅ 모든 필터 조합에서 오류 없이 동작

**구현 파일 (Phase 3)**
- data_loader.py (454줄)
- app.py (487줄)
- PHASE3_COMPLETION.md (완료 보고서)
